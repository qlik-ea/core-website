# Mira - a QIX Engine Discovery Service

## Overview

_Mira_ is a microservice used for QIX Engine discovery in a Docker containerized environment. Mira keeps track of QIX Engine containers running in a Docker deployment.

The purpose of the service is mainly for other services to be able to query available QIX Engine instances with certain properties. From this information decisions can be made, e.g. which engine that is suitable to open a new session towards, or if there is a need to start a new QIX Engine in order to serve a client's request to get the QIX Engine resource.

## Docker Image

Mira is distributed as a Docker image built from source in this repository and is available on Docker Hub as [qlikea/mira](https://hub.docker.com/r/qlikea/mira).

## API

Mira's REST API is described in the [api-doc.yml](./doc/api-doc.yml) [OpenAPI](https://www.openapis.org/) document. The OpenAPI specification is generated from JSDoc, and can be regenerated by running:

```sh
$ npm install
$ npm run generate-openapi
```

Mira exposes its REST API on port `9100`. This port is built into the Docker image and exposed using the `EXPOSE` [Dockerfile](./Dockerfile) command.

## Discovery

Engine discovery in Mira is based on labeling. Mira assumes that Engine containers are labeled according some simple rules. Engines that are not labeled, will not be discovered and returned by Mira. Depending on which operation mode Mira runs in (see below) the entities that need to be labeled differs. Since the supported orchestration platforms have similar support, this does not vary too much and it should be fairly easy to translate labeling from one to the other.

### Discovery Labeling

Mira searches for a specific label key to identify an engine instance. By default, this label key is `qix-engine` but can be configured using the `MIRA_DISCOVERY_LABEL` environment variable. Note that Mira only looks at the label key and ignores its value. The values can even be omitted.

### Port Labeling

In addition to the disovery label described above, Mira also identifies labels on an engine instance to determine which ports it serves the QIX API (websocket) on, and which port it serves the `/metrics` endpoint on. By default, Mira identifies and uses the values of the labels `qix-engine-api-port` and `qix-engine-metrics-port`. These label keys can be configured using the environment variables `MIRA_ENGINE_API_PORT_LABEL` and `MIRA_ENGINE_METRICS_PORT_LABEL` respectively.

If an engine instance does not have these labels set, Mira defaults to setting the QIX API port to `9076` and the `/metrics` port to `9090`

## Operation Modes

Mira supports different operation modes. The operation mode determines what operations Mira uses to discover QIX Engine instances. This depends on
1. The orchestration environment in which QIX Engine instances are running. This environment must be explicitly provided when starting Mira. Currently _local_, _swarm_, and _kubernetes_ environments are supported.
1. Whether Mira itself runs containerized (the standard/most common case), or if Mira is started as a Node.js process, "non-Dockerized". Mira detects this operation mode automatically.

### Environment Variables

The following environment variable can optionally be set for Mira

| Name                                  | Default value           | Description |
|---------------------------------------|-------------------------|-------------|
| MIRA_MODE                             | swarm                   | The operation mode of Mira which can be `local`, `swarm` or `kubernetes`. |
| MIRA_DISCOVERY_LABEL                  | qix-engine              | Label key that Mira uses to identify engine instances. |
| MIRA_DISCOVERY_HOSTNAME               | n/a                     | Hostname that Mira uses to query DNS for engine instances. |
| MIRA_ENGINE_API_PORT_LABEL            | qix-engine-api-port     | Label that Mira will use to determine the QIX API (websocket) port. |
| MIRA_ENGINE_METRICS_PORT_LABEL        | qix-engine-metrics-port | Label that Mira will use to determine the `/metrics` port. |
| MIRA_ENGINE_DISCOVERY_REFRESH_RATE    | 1000                    | Refresh rate in milliseconds for discovering engines. |
| MIRA_ENGINE_HEALTH_REFRESH_RATE       | 5000                    | Refresh rate in milliseconds for checking if engines are healthy. |
| MIRA_KUBERNETES_PROXY_PORT            | 8001                    | Port that mira will use to talk to kubernetes api server. |
